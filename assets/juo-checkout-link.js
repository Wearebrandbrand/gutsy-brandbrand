class w{constructor(t){this.status=422,this.message="Cart Error",this.description=t}}class m{constructor(){this.status=404,this.message="Cart Error",this.description="Cannot find variant"}}class C{init(){this.emitCartChanges().then(()=>{this.observeCartChanges()})}checkResponse(t){if(t.status===404)throw new m;if(t.status===422)throw new w(t.description);if(t.token)return t;throw new Error("No token provided in the Shopify Cart response")}async fetchCart(){const o=await(await fetch("/cart.js")).json();return this.checkResponse(o)}storeCart(t){localStorage.setItem("juo-cart",JSON.stringify(t))}storedCart(){const t=localStorage.getItem("juo-cart");return t!=null?JSON.parse(t):{items:[]}}findCartChanges(t,o){const s=(l,c)=>l.filter(u=>!c.some(d=>u.key==d.key)),a={added:s(o.items,t.items),removed:s(t.items,o.items)};return t.items.forEach(l=>{const c=o.items.find(y=>y.key==l.key&&y.quantity!=l.quantity);if(!c)return;const u=c.quantity-l.quantity,d={...c};d.quantity=Math.abs(u),u>0?a.added.push(d):a.removed.push(d)}),a}async emitCartChanges(){const t=await this.fetchCart(),o=this.storedCart(),s=this.findCartChanges(o,t);if(s.added.length>0||s.removed.length>0){const a=new CustomEvent("cart_changed",{detail:s});this.storeCart(t),window.dispatchEvent(a)}}observeCartChanges(){this.cartObserver=new PerformanceObserver(t=>{t.getEntries().forEach(o=>{const s=["xmlhttprequest","fetch"].includes(o.initiatorType),a=/\/cart\//.test(o.name);s&&a&&this.emitCartChanges()})}),this.cartObserver.observe({entryTypes:["resource"]})}stop(){this.cartObserver.disconnect()}}(function(){const f="#juo-go-to-checkout-with-ideal",t="form[action*='/cart'].juo-cart-drawer-submit",o="#Cart",s=new C,a=new Map;async function l(){var i;const n=document.querySelector(f);if(!n)return;n.setAttribute("disabled","disabled"),a.clear();const g=await fetch("/?section_id=juo-selling-plans");if(g.status!==200){console.error("Failed to load selling plans");return}try{const e=document.createElement("div");e.innerHTML=await g.text();const h=JSON.parse(((i=e.querySelector("template"))==null?void 0:i.innerHTML)??"{}");Object.entries(h).map(([r,p])=>{p!=null&&a.set(r,p)})}catch{console.error("Failed to load selling plans")}s.storedCart().items.filter(e=>e.selling_plan_allocation).length==a.size&&n.removeAttribute("disabled")}function c(){const n=[document.querySelector(t),document.querySelector(o)];if(n.every(e=>e==null)){console.warn("No cart form found");return}const i=s.storedCart().items.some(e=>e.selling_plan_allocation);n.forEach(e=>{e&&e.classList[i?"add":"remove"]("has-selling-plan")}),i&&l()}async function u(){s.init(),document.addEventListener("click",d),window.addEventListener("cart_changed",c),l()}async function d(n){if(n==null||((n==null?void 0:n.target).matches(f)?n.target:null)==null)return;n.target.disabled=!0;const i=s.storedCart();if(!i.items.some(r=>r.selling_plan_allocation!=null?a.has(String(r.key)):!1)){window.location.href="/checkout";return}const h=i.items.map(r=>{const p=r.selling_plan_allocation!=null?a.get(String(r.key)):null;return{id:r.variant_id,quantity:r.quantity,properties:{...r.properties,...r.selling_plan_allocation!=null&&p!=null?{_selling_plan_id:String(r.selling_plan_allocation.selling_plan.id)}:{}},...r.selling_plan_allocation!=null?{selling_plan:p??String(r.selling_plan_allocation.selling_plan.id)}:{}}});s.stop(),fetch(window.Shopify.routes.root+"cart/clear").then(async()=>{try{if((await fetch(window.Shopify.routes.root+"cart/add.js",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({attributes:i.attributes,items:h})})).status!==200)throw new Error("Failed to add items to cart");window.location.href="/checkout?skip_shop_pay=true"}catch(r){console.error(r),s.observeCartChanges()}})}async function y(){const n=await s.fetchCart();if(!n.items.some(e=>e.properties._selling_plan_id!=null&&e.properties._selling_plan_id!==""))return;const i=n.items.map(e=>{const h=e.properties._selling_plan_id!=null&&e.properties._selling_plan_id!=="";return{id:e.variant_id,quantity:e.quantity,properties:{...e.properties,...h?{_selling_plan_id:""}:{}},...h?{selling_plan:e.properties._selling_plan_id}:{}}});await fetch(window.Shopify.routes.root+"cart/clear"),await fetch(window.Shopify.routes.root+"cart/add.js",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({attributes:n.attributes,items:i})})}function _(){window.Shopify!=null&&(u(),c(),y())}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",_):_()})();
