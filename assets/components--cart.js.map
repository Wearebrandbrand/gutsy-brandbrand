{"version":3,"file":"components--cart.js","sources":["../theming/js/components/cart.js"],"sourcesContent":["/**\n *  @class\n *  @function Cart\n */\nclass Cart {\n\n  constructor() {\n    this.container = document.getElementById('Cart');\n    this.setupEventListeners();\n  }\n\n  onChange(event) {\n    if (event.target.type == 'number') {\n      this.updateQuantity(event.target.dataset.index, event.target.value);\n    } else if (event.target.getAttribute('id') == 'CartSpecialInstructions') {\n      this.saveNotes();\n    }\n  }\n\n  saveNotes() {\n    fetch(`${theme.routes.cart_update_url}.js`, {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json',\n        'Accept': `application/json`\n      },\n      body: JSON.stringify({\n        'note': document.getElementById('CartSpecialInstructions').value\n      })\n    });\n  }\n\n  setupEventListeners() {\n    this.removeProductEvent();\n\n    this.debouncedOnChange = debounce((event) => {\n      this.onChange(event);\n    }, 300);\n\n    document.addEventListener('cart:refresh', (event) => {\n      this.refresh();\n    });\n\n    this.container.addEventListener('change', this.debouncedOnChange.bind(this));\n\n    this.termsCheckbox();\n  }\n\n  getSectionsToRender() {\n    return [{\n      id: 'Cart',\n      section: 'main-cart',\n      selector: '.thb-cart-form'\n    },\n      {\n        id: 'cart-drawer-toggle',\n        section: 'cart-bubble',\n        selector: '.thb-item-count'\n      }];\n  }\n\n  displayErrors(line, message) {\n    const lineItemError =\n      document.getElementById(`Line-item-error-${line}`) || document.getElementById(`CartDrawer-LineItemError-${line}`);\n    if (lineItemError) {\n      lineItemError.removeAttribute('hidden');\n      lineItemError.querySelector('.cart-item__error-text').innerHTML = message;\n      this.container.querySelector(`#CartItem-${line}`).classList.remove('loading');\n    }\n  }\n\n  getSectionInnerHTML(html, selector) {\n    return new DOMParser()\n    .parseFromString(html, 'text/html')\n    .querySelector(selector).innerHTML;\n  }\n\n  updateQuantity(line, quantity) {\n\n    this.container.classList.add('cart-disabled');\n    if (line) {\n      this.container.querySelector(`#CartItem-${line}`).classList.add('loading');\n    }\n\n    const body = JSON.stringify({\n      line,\n      quantity,\n      sections: this.getSectionsToRender().map((section) => section.section),\n      sections_url: window.location.pathname\n    });\n    dispatchCustomEvent('line-item:change:start', {\n      quantity: quantity\n    });\n    fetch(`${theme.routes.cart_change_url}`, {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json',\n        'Accept': `application/json`\n      },\n      ...{\n        body\n      }\n    })\n    .then((response) => {\n      return response.text();\n    })\n    .then((state) => {\n      const parsedState = JSON.parse(state);\n\n      if (parsedState.errors) {\n        this.displayErrors(line, parsedState.errors);\n        this.container.classList.remove('cart-disabled');\n        return;\n      }\n      this.renderContents(parsedState, line, false);\n\n      this.container.classList.remove('cart-disabled');\n\n      dispatchCustomEvent('line-item:change:end', {\n        quantity: quantity,\n        cart: parsedState\n      });\n    });\n  }\n\n  refresh() {\n    this.container.classList.add('cart-disabled');\n\n    let sections = 'main-cart';\n\n    fetch(`${window.location.pathname}?sections=${sections}`)\n    .then((response) => {\n      return response.text();\n    })\n    .then((state) => {\n      const parsedState = JSON.parse(state);\n\n\n      if (parsedState.errors) {\n        this.displayErrors(line, parsedState.errors);\n        this.container.classList.remove('cart-disabled');\n        return;\n      }\n\n      this.renderContents(parsedState, false, true);\n\n      this.container.classList.remove('cart-disabled');\n    });\n  }\n\n  termsCheckbox() {\n    let terms_checkbox = this.container.querySelector('#CartTerms'),\n      checkout_button = this.container.querySelector('.button.checkout-button');\n\n    if (terms_checkbox && checkout_button) {\n      terms_checkbox.setCustomValidity(theme.strings.requiresTerms);\n      checkout_button.addEventListener('click', function (e) {\n        if (!terms_checkbox.checked) {\n          terms_checkbox.reportValidity();\n          terms_checkbox.focus();\n          e.preventDefault();\n        }\n      });\n    }\n  }\n\n  removeProductEvent() {\n    let removes = this.container.querySelectorAll('.remove');\n\n    removes.forEach((remove) => {\n      remove.addEventListener('click', (event) => {\n        this.updateQuantity(event.target.dataset.index, '0');\n\n        event.preventDefault();\n      });\n    });\n  }\n\n  renderContents(parsedState, line, refresh) {\n    this.getSectionsToRender().forEach((section => {\n      const elementToReplace = document.getElementById(section.id).querySelector(section.selector) || document.getElementById(section.id);\n\n      if (refresh) {\n        if (parsedState[section.section]) {\n          elementToReplace.innerHTML = this.getSectionInnerHTML(parsedState[section.section], section.selector);\n        }\n      } else {\n        elementToReplace.innerHTML = this.getSectionInnerHTML(parsedState.sections[section.section], section.selector);\n      }\n\n      this.removeProductEvent();\n\n      if (line && this.container.querySelector(`#CartItem-${line}`)) {\n        this.container.querySelector(`#CartItem-${line}`).classList.remove('loading');\n      }\n      this.termsCheckbox();\n    }));\n  }\n}\n\nwindow.addEventListener('load', () => {\n  if (typeof Cart !== 'undefined') {\n    new Cart();\n  }\n});"],"names":["Cart","event","line","message","lineItemError","html","selector","quantity","body","section","response","state","parsedState","terms_checkbox","checkout_button","e","remove","refresh","elementToReplace"],"mappings":"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"}